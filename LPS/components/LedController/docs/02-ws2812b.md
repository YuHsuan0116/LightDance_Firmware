# 02 - WS2812B Driver (`ws2812b.c`)

This document describes the low-level WS2812B transport driver used by `LedController`.

## 1. Scope

Driver responsibilities:
- Create and destroy RMT TX channel/encoder
- Maintain a local GRB buffer per strip
- Transmit buffer through RMT
- Provide per-pixel and bulk write helpers

Public header:
- `components/LedController/include/ws2812b.h`

## 2. Data Model

Device struct (`ws2812b_dev_t`) contains:
- RMT handles (`rmt_channel`, `rmt_encoder`)
- Pin and strip length (`gpio_num`, `pixel_num`)
- Internal buffer:
  - `uint8_t buffer[3 * LD_BOARD_WS2812B_MAX_PIXEL_NUM]`
  - Byte order in buffer: `G, R, B` per pixel

Color APIs use `grb8_t` from `ld_led_types.h`.

## 3. API Summary

### 3.1 Lifecycle

- `esp_err_t ws2812b_init(ws2812b_dev_t* strip, gpio_num_t gpio_num, uint16_t pixel_num);`
- `esp_err_t ws2812b_del(ws2812b_dev_t* strip);`

Initialization flow:
1. Validate args
2. Clear struct
3. Create encoder
4. Create TX channel
5. Enable channel
6. Push initial black frame

### 3.2 Buffer Write

- `esp_err_t ws2812b_write_grb(ws2812b_dev_t* strip, const grb8_t* colors, uint16_t count);`
- `esp_err_t ws2812b_set_pixel(ws2812b_dev_t* strip, int pixel_idx, grb8_t color);`
- `esp_err_t ws2812b_fill(ws2812b_dev_t* strip, grb8_t color);`
- `esp_err_t ws2812b_get_pixel(ws2812b_dev_t* strip, int pixel_idx, grb8_t* out_color);`

These APIs only modify local buffer; they do not drive hardware until `ws2812b_show()`.

### 3.3 Transmission

- `esp_err_t ws2812b_show(ws2812b_dev_t* strip);`
- `esp_err_t ws2812b_wait_done(ws2812b_dev_t* strip);`

`show()` is non-blocking from RMT queue perspective.
Call `wait_done()` when you need transfer completion.

### 3.4 Debug

- `esp_err_t ws2812b_print_buffer(ws2812b_dev_t* strip);`

Prints header and buffer hexdump using ESP-IDF logging.

## 4. Runtime Limits And Validation

- `pixel_num` must be `> 0` and `<= LD_BOARD_WS2812B_MAX_PIXEL_NUM`
- `count` in `ws2812b_write_grb` must be `<= strip->pixel_num`
- `pixel_idx` must be in `[0, strip->pixel_num - 1]`

Invalid arguments return `ESP_ERR_INVALID_ARG`.
Invalid channel/encoder state returns `ESP_ERR_INVALID_STATE`.

## 5. Example

```c
#include "ws2812b.h"
#include "esp_check.h"

static ws2812b_dev_t strip0;

void ws_demo(void) {
    ESP_ERROR_CHECK(ws2812b_init(&strip0, GPIO_NUM_18, 60));

    ESP_ERROR_CHECK(ws2812b_fill(&strip0, grb8(0, 0, 0)));
    ESP_ERROR_CHECK(ws2812b_set_pixel(&strip0, 0, grb8(255, 0, 0)));
    ESP_ERROR_CHECK(ws2812b_show(&strip0));
    ESP_ERROR_CHECK(ws2812b_wait_done(&strip0));
}
```
