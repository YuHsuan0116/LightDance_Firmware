# 02 - WS2812B LED Driver (RMT)

This module implements a high-performance driver for WS2812B (and compatible) addressable LED strips using the **ESP32 RMT (Remote Control)** peripheral. It handles signal encoding, memory buffering, and hardware transmission.

## 1. Overview

* **Hardware Interface:** ESP32 RMT TX Channel.
* **Encoding:** 1-wire protocol (NZR - Non-Return-to-Zero).
* **Resolution:** 10 MHz RMT resolution for precise timing.
* **Color Format:** GRB (Green-Red-Blue).

---

## 2. Memory Architecture & Layout

This driver uses a **statically allocated buffer approach** embedded directly within the device structure to ensure memory locality and reduce fragmentation.

### 2.1 Struct Memory Layout (`ws2812b_dev_t`)

The internal buffer size is fixed at compile-time based on `WS2812B_MAX_PIXEL_NUM`.

> **⚠️ Critical Note on Stack Usage:**
> Because `ws2812b_dev_t` contains a large byte array (`buffer`), **do not allocate this structure on the specific task stack** (local variable) if `MAX_PIXEL_NUM` is large.
>
> **Recommended:** Allocate as a global `static` variable or via `malloc/calloc` on the heap.

**Memory Map:**

```text
[ ws2812b_dev_t Object ]
+-------------------------------------------------------------+
|  rmt_channel (4 bytes)  |  Handle to hardware TX channel    |
+-------------------------------------------------------------+
|  rmt_encoder (4 bytes)  |  Handle to RMT bit encoder        |
+-------------------------------------------------------------+
|  gpio_num    (4 bytes)  |  Output Pin                       |
+-------------------------------------------------------------+
|  pixel_num   (2 bytes)  |  Actual used pixels (dynamic)     |
+-------------------------------------------------------------+
|  buffer[]    (Array)    |  Raw Byte Storage                 |
|                         |  Size = 3 * WS2812B_MAX_PIXEL_NUM |
|  [ G0, R0, B0, G1, R1, B1, ... Gn, Rn, Bn ]                 |
+-------------------------------------------------------------+
```

### 2.2 Byte Ordering (GRB)
WS2812B LEDs expect data in **Green -> Red -> Blue** order. The driver automatically handles this mapping in `ws2812b_set_pixel`.

| Byte Offset | Content |
| :--- | :--- |
| `Offset + 0` | **Green** |
| `Offset + 1` | **Red** |
| `Offset + 2` | **Blue** |

---

## 3. RMT Implementation Details

The driver utilizes the ESP-IDF RMT driver with the following specific configurations:

* **Clock Resolution:** `10,000,000 Hz` (10 MHz). This allows for 100ns precision, sufficient for the strict WS2812B timing (T0H, T1H codes).
* **Transmission Mode:** Non-blocking (`queue_nonblocking = true`).
* **DMA:** Disabled (uses internal RMT MEM blocks, size = 64 symbols).

## 4. API Reference

### Initialization
```c
esp_err_t ws2812b_init(ws2812b_dev_t* strip, gpio_num_t gpio, uint16_t pixels);
```
* Initializes the RMT channel and encoder.
* Clears the LED strip (sets to black) immediately upon init.
* **Constraints:** `pixels` must not exceed `WS2812B_MAX_PIXEL_NUM`.

### Pixel Manipulation
These functions modify the internal `buffer` but **do not** update the physical LEDs immediately.

```c
// Bulk copy from an external buffer
esp_err_t ws2812b_write(ws2812b_dev_t* strip, uint8_t* external_buffer);

// Fill entire strip with one color (Optimized with memset if color is 0,0,0)
esp_err_t ws2812b_fill(ws2812b_dev_t* strip, uint8_t r, uint8_t g, uint8_t b);

// Set specific pixel (Auto-converts RGB inputs to GRB buffer)
esp_err_t ws2812b_set_pixel(ws2812b_dev_t* strip, int idx, uint8_t r, uint8_t g, uint8_t b);
```

### Hardware Update
```c
// Sends the buffer to the LEDs via RMT
esp_err_t ws2812b_show(ws2812b_dev_t* strip);

// Blocks until the previous RMT transmission is finished
esp_err_t ws2812b_wait_done(ws2812b_dev_t* strip);
```

### Debugging
```c
// Prints a HEX dump of the internal buffer to the console
esp_err_t ws2812b_print_buffer(ws2812b_dev_t* strip);
```

## 5. Usage Example

```c
#include "ws2812b_hal.h"

// 1. Allocate device struct (Heap or Global Static)
static ws2812b_dev_t my_led_strip;

void app_main() {
    // 2. Initialize Hardware
    ESP_ERROR_CHECK(ws2812b_init(&my_led_strip, GPIO_NUM_18, 60));

    // 3. Set Colors (Modify Buffer)
    ws2812b_fill(&my_led_strip, 0, 0, 0); // Clear
    ws2812b_set_pixel(&my_led_strip, 0, 255, 0, 0); // Pixel 0 -> Red

    // 4. Push to LEDs
    ws2812b_show(&my_led_strip);
    
    // 5. Cleanup (if needed)
    // ws2812b_del(&my_led_strip);
}
```