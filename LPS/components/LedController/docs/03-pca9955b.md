# 03 - PCA9955B LED Driver (I2C)

This module implements the driver for the **NXP PCA9955B**, a 16-channel constant current LED driver controlled via I2C. The driver abstracts the 16 hardware channels into **5 logical RGB pixels**.

## 1. Overview

* **Communication:** I2C Bus (Fast Mode 400kHz).
* **Driver Mode:** Constant Current (CC).
* **Addressing:** 7-bit I2C Address (configurable).
* **Logical Mapping:** 5 RGB LEDs (Channels 0–14 used, Channel 15 unused).

---

## 2. Memory Architecture (Shadow Buffer)

To minimize I2C overhead, this driver maintains a local **Shadow Buffer** that mirrors the device's internal PWM registers. All color manipulation functions (`set_pixel`, `fill`) modify this local RAM buffer. The data is only sent to the hardware when `pca9955b_show()` is called.

### 2.1 Struct Layout (`pca9955b_buffer_t`)

The buffer is designed to match the hardware's **Auto-Increment** write format exactly. This allows the entire state to be flushed in a single I2C transaction.

```text
[ pca9955b_buffer_t ]
+----------------------+-------------------------------------------------------+
|  command_byte (1B)   |  Register Addr (0x08 PWM0) | Auto-Inc Flag (0x80)     |
+----------------------+-------------------------------------------------------+
|  data[] (15 Bytes)   |  PWM Brightness Data (0-255)                          |
|                      |  [ R0, G0, B0, R1, G1, B1 ... R4, G4, B4 ]            |
+----------------------+-------------------------------------------------------+
```

### 2.2 Logical Mapping
The driver maps the linear hardware channels to RGB triplets:

| Logical LED | Buffer Index | Hardware Channels |
| :--- | :--- | :--- |
| **Pixel 0** | `ch[0]` | PWM 0, 1, 2 |
| **Pixel 1** | `ch[1]` | PWM 3, 4, 5 |
| **Pixel 2** | `ch[2]` | PWM 6, 7, 8 |
| **Pixel 3** | `ch[3]` | PWM 9, 10, 11 |
| **Pixel 4** | `ch[4]` | PWM 12, 13, 14 |

---

## 3. Robustness & Error Recovery

The PCA9955B has a volatile **IREF (Current Reference)** register that determines the global brightness gain. If the device resets (e.g., power dip), this register defaults to 0, turning off all LEDs.

**The driver implements an auto-recovery mechanism:**
1. **Detection:** If `i2c_master_transmit` fails (ACK error or timeout), the driver sets a flag: `need_reset_IREF = true`.
2. **Recovery:** On the *next* call to `pca9955b_show()`, the driver first attempts to re-write the IREF register to `0xFF` before sending color data.
3. **Result:** This ensures the display recovers automatically without requiring a full system reboot.

## 4. API Reference

### Bus Initialization
Helper function to set up the ESP32 I2C Master bus.
```c
esp_err_t i2c_bus_init(gpio_num_t sda, gpio_num_t scl, i2c_master_bus_handle_t* ret_handle);
```

### Device Initialization
```c
esp_err_t pca9955b_init(pca9955b_dev_t* dev, uint8_t addr, i2c_master_bus_handle_t bus_handle);
```
* Adds the device to the I2C bus.
* Sets `IREFALL` to `0xFF` (Max Current).
* Clears all LEDs (Black).

### Color Manipulation
*Modifies Shadow Buffer Only*
```c
// Bulk write raw bytes (15 bytes)
// ⚠️ IMPORTANT: Input buffer must be in GRB order (Green, Red, Blue)
esp_err_t pca9955b_write(pca9955b_dev_t* dev, const uint8_t* buffer);

// Fill all 5 pixels with same color
esp_err_t pca9955b_fill(pca9955b_dev_t* dev, uint8_t r, uint8_t g, uint8_t b);

// Set specific pixel (0-4)
esp_err_t pca9955b_set_pixel(pca9955b_dev_t* dev, uint8_t idx, uint8_t r, uint8_t g, uint8_t b);
```

### Hardware Update
```c
esp_err_t pca9955b_show(pca9955b_dev_t* dev);
```
* **Critical Function:** Performs the actual I2C transmission.
* Checks `need_reset_IREF` state and restores current gain if needed.
* Sends the Command Byte + 15 Data Bytes in one burst.

## 5. Usage Example

```c
#include "pca9955b_hal.h"

static pca9955b_dev_t driver_ic_1;
static i2c_master_bus_handle_t i2c_bus;

void app_main() {
    // 1. Initialize I2C Bus (Once)
    i2c_bus_init(GPIO_NUM_21, GPIO_NUM_22, &i2c_bus);

    // 2. Initialize Driver IC (Address 0x05)
    pca9955b_init(&driver_ic_1, 0x05, i2c_bus);

    // 3. Set Colors (Update Buffer)
    pca9955b_fill(&driver_ic_1, 0, 0, 0);       // Clear
    pca9955b_set_pixel(&driver_ic_1, 0, 255, 0, 0); // LED 0 -> Red

    // 4. Send to Hardware
    pca9955b_show(&driver_ic_1);

     // 5. Cleanup (if needed)
    // pca9955b_del(&driver);
}
```