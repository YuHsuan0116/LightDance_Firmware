# 03 - PCA9955B Driver (`pca9955b.c`)

This document describes the PCA9955B I2C driver used by `LedController`.

## 1. Scope

Driver responsibilities:
- Create shared I2C master bus (`i2c_bus_init`)
- Attach PCA9955B device handle to bus
- Maintain shadow color buffer per chip
- Flush buffer to hardware
- Handle basic recovery when IREF needs restoration

Public header:
- `components/LedController/include/pca9955b.h`

## 2. Data Model

### 2.1 Shadow Buffer

`pca9955b_buffer_t` matches one burst-write layout:
- `command_byte`: starts at `PWM0` with auto-increment flag
- `data[15]`: five logical RGB pixels (`5 * 3`)

Logical mapping:
- `ch[0]` -> pixel 0 (`R,G,B`)
- ...
- `ch[4]` -> pixel 4 (`R,G,B`)

### 2.2 Device Context

`pca9955b_dev_t` stores:
- `i2c_dev_handle`
- `i2c_addr`
- shadow buffer
- `need_reset_IREF` recovery flag

## 3. API Summary

### 3.1 Bus and Device Lifecycle

- `esp_err_t i2c_bus_init(gpio_num_t sda, gpio_num_t scl, i2c_master_bus_handle_t* ret_i2c_bus_handle);`
- `esp_err_t pca9955b_init(pca9955b_dev_t* dev, uint8_t i2c_addr, i2c_master_bus_handle_t bus_handle);`
- `esp_err_t pca9955b_del(pca9955b_dev_t* dev);`

Init flow:
1. Add device to I2C master bus
2. Write IREF default command
3. Clear LED PWM payload to black

### 3.2 Buffer Write

- `esp_err_t pca9955b_set_pixel(pca9955b_dev_t* dev, uint8_t pixel_idx, grb8_t color);`
- `esp_err_t pca9955b_write_grb(pca9955b_dev_t* dev, const grb8_t* colors, uint8_t count);`
- `esp_err_t pca9955b_fill(pca9955b_dev_t* dev, grb8_t color);`

Public input is `grb8_t`.
Driver stores into internal RGB register order.

### 3.3 Flush

- `esp_err_t pca9955b_show(pca9955b_dev_t* dev);`

Flushes one burst frame:
- command byte + 15-byte payload

## 4. Recovery Behavior

If transmit fails in `pca9955b_show()`:
- Driver sets `need_reset_IREF = true`
- Next `show()` tries to restore IREF first

This helps recovery after power glitches or device-side register reset.

## 5. Constraints

- I2C address must be `< 0x80`
- Pixel index range: `0 .. LD_BOARD_PCA9955B_RGB_PER_IC - 1`
- Bulk count max: `LD_BOARD_PCA9955B_RGB_PER_IC`

## 6. Example

```c
#include "pca9955b.h"
#include "esp_check.h"

static i2c_master_bus_handle_t bus = NULL;
static pca9955b_dev_t dev0;

void pca_demo(void) {
    ESP_ERROR_CHECK(i2c_bus_init(LD_BOARD_I2C_SDA_GPIO, LD_BOARD_I2C_SCL_GPIO, &bus));
    ESP_ERROR_CHECK(pca9955b_init(&dev0, 0x1f, bus));

    ESP_ERROR_CHECK(pca9955b_fill(&dev0, grb8(0, 0, 0)));
    ESP_ERROR_CHECK(pca9955b_set_pixel(&dev0, 0, grb8(255, 0, 0)));
    ESP_ERROR_CHECK(pca9955b_show(&dev0));
}
```
